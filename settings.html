<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>設定 — 背景変更</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .settings { padding: 16px; display: grid; gap: 16px; }
      .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
      .head { font-weight: 700; margin-bottom: 8px; }
      .choices { display: grid; grid-template-columns: repeat(2, 120px); gap: 12px; }
      .card { display: grid; gap: 6px; justify-items: center; padding: 8px; border: 1px solid #d1d5db; border-radius: 10px; background: #f9fafb; cursor: pointer; }
      .card img { width: 100px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb; background: #fff; }
      .card .label { font-size: 12px; color: #374151; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .muted { color: #6b7280; }
      .notice { font-size: 12px; color: #6b7280; }
    </style>
  </head>
  <body>
    <div class="settings">
      <div style="display:grid; justify-items:center; margin-top:50px;">
        <label style="display:grid; gap:6px; justify-items:center;">
          <div><strong>受信側サイズ</strong> <span class="muted">（今の大きさ=100）</span></div>
          <input id="scaleReceiver" type="range" min="1" max="100" value="50" style="width:320px;">
          <div class="muted">現在: <span id="scaleVal">50</span>%</div>
        </label>
      </div>
      <div><strong>背景設定</strong> <span class="muted">（クリックで送信／即時反映）</span></div>
      <div class="row">
        <div class="panel" id="senderPanel">
          <div class="head">書き手（送信）背景</div>
          <div class="choices">
            <div class="card" data-target="sender" data-mode="white">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='280'%3E%3Crect width='100%25' height='100%25' fill='white'/%3E%3C/svg%3E" alt="白"/>
              <div class="label">白背景</div>
            </div>
            <div class="card" data-target="sender" data-mode="image" data-url="back2.png">
              <img src="back2.png" alt="back2.png"/>
              <div class="label">back2.png</div>
            </div>
          </div>
        </div>
        <div class="panel" id="receiverPanel">
          <div class="head">受信背景</div>
          <div class="choices">
            <div class="card" data-target="receiver" data-mode="white">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='280'%3E%3Crect width='100%25' height='100%25' fill='white'/%3E%3C/svg%3E" alt="白"/>
              <div class="label">白背景</div>
            </div>
            <div class="card" data-target="receiver" data-mode="image" data-url="back2.png">
              <img src="back2.png" alt="back2.png"/>
              <div class="label">back2.png</div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="panel" id="rotatePanel">
          <div class="head">受信キャンバスの回転</div>
          <div class="choices">
            <div class="card" data-target="rotate" data-rot="0">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='280'%3E%3Crect width='100%25' height='100%25' fill='white'/%3E%3C/svg%3E" alt="0度"/>
              <div class="label">0度</div>
            </div>
            <div class="card" data-target="rotate" data-rot="180">
              <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='280'%3E%3Crect width='100%25' height='100%25' fill='white'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='24' fill='black'%3E180°%3C/text%3E%3C/svg%3E" alt="180度"/>
              <div class="label">180度</div>
            </div>
          </div>
          <div class="notice">既定は180度（受信側のみ反映）</div>
        </div>
      </div>
      <div class="notice">注: back2.png はプロジェクト直下に配置してください。GitHub Pagesでは相対URLで配信されます。</div>
    </div>

    <script src="sender-config.js"></script>
    <script>
      (function(){
        const qs = new URLSearchParams(location.search);
        const SERVER_URL = (qs.get('server') || (window.SERVER_URL || '')).trim();
        const CHANNEL = (qs.get('channel') || (window.CHANNEL || 'default')).trim();
        if (!SERVER_URL) { console.warn('SERVER_URL is empty; settings will not broadcast.'); }

        function toWs(u){ return u.replace(/^http/, 'ws').replace(/\/$/, ''); }
        const url = `${toWs(SERVER_URL)}/ws?channel=${encodeURIComponent(CHANNEL)}&role=config`;
        let ws = null;
        try { ws = new WebSocket(url); } catch(_) {}

        function absoluteIfPossible(u){
          if (!u) return u;
          if (/^https?:/i.test(u)) return u;
          if (location.protocol === 'http:' || location.protocol === 'https:') {
            try { return new URL(u, location.href).href; } catch(_) { return u; }
          }
          return u; // file:// の場合はそのまま
        }
        function sendConfig(part, mode, url){
          const data = {};
          if (mode === 'white') data[part === 'receiver' ? 'bgReceiver' : 'bgSender'] = 'white';
          else data[part === 'receiver' ? 'bgReceiver' : 'bgSender'] = { mode: 'image', url: absoluteIfPossible(url) };
          const msg = { type: 'config', data };
          if (ws && ws.readyState === 1) ws.send(JSON.stringify(msg));
          // HTTP fallback
          fetch(`${SERVER_URL.replace(/^wss?:\/\//i, (m)=>m.toLowerCase()==='wss://'?'https://':'http://').replace(/\/$/, '')}/config?channel=${encodeURIComponent(CHANNEL)}`,
            { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ data }) })
            .catch(()=>{});
        }

        function sendScaleReceiver(val){
          const v = Math.max(1, Math.min(100, Math.round(val)));
          const data = { scaleReceiver: v };
          const msg = { type: 'config', data };
          if (ws && ws.readyState === 1) ws.send(JSON.stringify(msg));
          fetch(`${SERVER_URL.replace(/^wss?:\/\//i, (m)=>m.toLowerCase()==='wss://'?'https://':'http://').replace(/\/$/, '')}/config?channel=${encodeURIComponent(CHANNEL)}`,
            { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ data }) }).catch(()=>{});
        }

        // file:// の場合、相対パスで選んだ画像は ../ にフォールバックしてみる
        function normalizeLocalUrl(u){
          if (!u) return u;
          if (/^https?:/i.test(u)) return u;
          if (location.protocol === 'file:') return '../' + u.replace(/^\/+/, '');
          return u;
        }

        document.querySelectorAll('.card').forEach(card => {
          card.addEventListener('click', () => {
            const target = card.getAttribute('data-target');
            if (target === 'rotate') {
              const rot = Number(card.getAttribute('data-rot') || '0');
              const data = { rotateReceiver: (rot === 180) ? 180 : 0 };
              const msg = { type: 'config', data };
              if (ws && ws.readyState === 1) ws.send(JSON.stringify(msg));
              fetch(`${SERVER_URL.replace(/^wss?:\/\//i, (m)=>m.toLowerCase()==='wss://'?'https://':'http://').replace(/\/$/, '')}/config?channel=${encodeURIComponent(CHANNEL)}`,
                { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ data }) }).catch(()=>{});
              return;
            }
            const mode = card.getAttribute('data-mode');
            const url = normalizeLocalUrl(card.getAttribute('data-url'));
            sendConfig(target, mode, url);
          });
        });

        const scaleEl = document.getElementById('scaleReceiver');
        const scaleVal = document.getElementById('scaleVal');
        let timer = null;
        scaleEl.addEventListener('input', () => {
          scaleVal.textContent = scaleEl.value;
          clearTimeout(timer); timer = setTimeout(() => sendScaleReceiver(scaleEl.value), 100);
        });
      })();
    </script>
  </body>
  </html>
