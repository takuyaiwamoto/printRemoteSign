<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>演出オーバーレイ</title>
    <style>
      :root { --alpha: 0.5; }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: rgba(0,0,0,var(--alpha)); /* 半透明 */
        color: #ffffff;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", Meiryo, sans-serif;
        -webkit-user-select: none;
      }
      .bar {
        position: fixed; inset: 0 0 auto 0; height: 44px;
        -webkit-app-region: drag; /* ドラッグで移動 */
      }
      .btns { position: absolute; right: 8px; top: 8px; display: grid; grid-auto-flow: column; gap: 8px; }
      .btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid rgba(255,255,255,.6); background: rgba(0,0,0,.25); 
             display: grid; place-items: center; cursor: pointer; -webkit-app-region: no-drag; }
      .btn:hover { background: rgba(0,0,0,.35); }
      .icon { width: 16px; height: 16px; display: block; }
      .center { position: fixed; inset: 0; display: grid; place-items: center; pointer-events: none; }
      .img-wrap { position: fixed; inset: 0; display: grid; place-items: center; }
      .img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }
      .move-up { transform: translateY(-120%); }
      .animate { transition: transform 800ms ease; }
      .hidden { display: none; }
      .label { font-size: 28px; font-weight: 800; letter-spacing: .1em; text-shadow: 0 2px 10px rgba(0,0,0,.35); }
    </style>
  </head>
  <body>
    <div class="bar">
      <div class="btns">
        <button id="btn-full" class="btn" title="最大化">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9V3h6"/><path d="M21 15v6h-6"/><path d="M21 9V3h-6"/><path d="M3 15v6h6"/>
          </svg>
        </button>
        <button id="btn-clear" class="btn" title="透明">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="9"/><path d="M5 5l14 14"/>
          </svg>
        </button>
      </div>
    </div>
    <div id="centerLabel" class="center hidden"><div class="label">透明中</div></div>
    <div id="imgWrap" class="img-wrap"><img id="waitImg" src="waiting.png" alt="waiting" /></div>

    <script>
      const fullBtn = document.getElementById('btn-full');
      const clearBtn = document.getElementById('btn-clear');
      const center = document.getElementById('centerLabel');
      const imgWrap = document.getElementById('imgWrap');
      const waitImg = document.getElementById('waitImg');

      // 既定は半透明（--alpha=0.5）
      function setAlpha(a){ document.documentElement.style.setProperty('--alpha', String(a)); }

      fullBtn?.addEventListener('click', () => { window.OverlayApi?.goFullscreen?.(); });

      clearBtn?.addEventListener('click', () => {
        // 背景を完全透明にしてボタンも隠す。中央に「透明中」を表示
        setAlpha(0);
        document.querySelector('.btns')?.classList.add('hidden');
        center?.classList.remove('hidden');
        // クリック透過を有効化して下のウィンドウを操作可能に
        setTimeout(() => { window.OverlayApi?.setPassThrough?.(true); }, 50);
        // 透明時は待機画像をフルで表示
        imgWrap.style.display = 'grid';
      });

      // --- Networking: subscribe to overlayStart via SSE ---
      (function(){
        const qs = new URLSearchParams(location.search);
        const SERVER = (qs.get('server')||'').trim();
        const CHANNEL = (qs.get('channel')||'default').trim();
        if (!SERVER) return;
        function toHttp(u){ return u.replace(/^wss?:\/\//i, (m)=>m.toLowerCase()==='wss://'?'https://':'http://').replace(/\/$/,''); }
        try {
          const es = new EventSource(`${toHttp(SERVER)}/events?channel=${encodeURIComponent(CHANNEL)}`);
          es.addEventListener('overlayStart', () => {
            try { console.log('[overlay] overlayStart'); } catch(_) {}
            // after 3s, move image up; then after 5s, move back down
            setTimeout(()=>{
              imgWrap.classList.add('animate');
              imgWrap.classList.add('move-up');
              setTimeout(()=>{ imgWrap.classList.remove('move-up'); }, 5000);
            }, 3000);
          });
        } catch(_) {}
      })();
    </script>
  </body>
  </html>
